# ==============================================================================
# PRODUCTION DOCKER COMPOSE - Docker Swarm Stack Configuration
# ==============================================================================
# This file defines how your app runs in production using Docker Swarm
# Deployed automatically via GitHub Actions using cssnr/stack-deploy-action
#
# Usage on VPS (manual):
#   docker stack deploy -c docker-compose.prod.yml race-standings-stack
#
# View stack:
#   docker stack ls
#   docker service ls
#   docker service ps race-standings-stack_backend --no-trunc
# ==============================================================================

version: '3.8'

services:
  
  # ----------------------------------------------------------------------------
  # BACKEND SERVICE - FastAPI application
  # ----------------------------------------------------------------------------
  backend:
    # Image from GHCR, tag set by GitHub Actions via envfile
    image: ${BACKEND_IMAGE:-ghcr.io/blakexyz/race-backend:latest}
    
    # Traefik labels for routing (if using Traefik reverse proxy)
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.race-backend.loadbalancer.server.port=8000"
      - "traefik.http.routers.race-backend.rule=Host(`api.austinrallyprojectresults.com`)"
      - "traefik.http.routers.race-backend.entrypoints=websecure"
      - "traefik.http.routers.race-backend.tls.certresolver=myresolver"

    networks: 
      - webnet
    
    environment:
      # API settings
      - PROJECT_NAME=Race Standings API
      - VERSION=1.0.0
      - API_V1_STR=/api/v1
      
      # CORS origins - allows frontend to call backend
      - BACKEND_CORS_ORIGINS=["https://austinrallyprojectresults.com","https://www.austinrallyprojectresults.com"]
      
      # Git commit hash for version tracking (set by GitHub Actions)
      - GIT_COMMIT_HASH=${GIT_COMMIT_HASH:-unknown}
      
      # STUB: Add when you need authentication
      # - SECRET_KEY=${SECRET_KEY}
      # - ALGORITHM=HS256
      # - ACCESS_TOKEN_EXPIRE_MINUTES=30
      
      # STUB: Add external service keys
      # - STRIPE_API_KEY=${STRIPE_API_KEY}
      # - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      
      # Logging
      - LOG_LEVEL=info
    
    # Swarm deployment configuration
    deploy:
      replicas: 1  # Number of containers to run
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1         # Update one container at a time
        delay: 10s             # Wait 10s between updates
        failure_action: rollback  # Rollback if update fails
        order: start-first     # Start new container before stopping old one
      # STUB: Add resource limits
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 512M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 256M


  # ----------------------------------------------------------------------------
  # FRONTEND SERVICE - React + Nginx
  # ----------------------------------------------------------------------------
  frontend:
    # Image from GHCR, tag set by GitHub Actions via envfile
    image: ${FRONTEND_IMAGE:-ghcr.io/blakexyz/race-frontend:latest}
    
    # Traefik labels for routing (if using Traefik reverse proxy)
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.race-frontend.loadbalancer.server.port=80"
      - "traefik.http.routers.race-frontend.rule=Host(`austinrallyprojectresults.com`) || Host(`www.austinrallyprojectresults.com`)"
      - "traefik.http.routers.race-frontend.entrypoints=websecure"
      - "traefik.http.routers.race-frontend.tls.certresolver=myresolver"
      # Redirect www to non-www (optional)
      - "traefik.http.middlewares.race-redirect-www.redirectregex.regex=^https://www\\.(.+)"
      - "traefik.http.middlewares.race-redirect-www.redirectregex.replacement=https://$${1}"
      - "traefik.http.routers.race-frontend.middlewares=race-redirect-www"
    
    networks: 
      - webnet
    
    environment:
      # Git commit hash for version tracking (set by GitHub Actions)
      - GIT_COMMIT_HASH=${GIT_COMMIT_HASH:-unknown}
      
      # API URL (already baked into build, but can override here)
      # - VITE_API_URL=https://api.your-domain.com
    
    # Swarm deployment configuration
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first  # Zero-downtime deployment
      # STUB: Add resource limits
      # resources:
      #   limits:
      #     cpus: '0.25'
      #     memory: 256M
      #   reservations:
      #     cpus: '0.10'
      #     memory: 128M
    
    # Start backend before frontend
    depends_on:
      - backend


# ==============================================================================
# NETWORKS - External network managed by Traefik
# ==============================================================================
networks:
  webnet:
    external: true # References the shared network created by the Traefik stack
    name: traefik-deploy_webnet  #  {stack name}_{network name}


# ==============================================================================
# SECRETS - No secrets needed (no database)
# ==============================================================================
# STUB: Add secrets when you need authentication or external services
# secrets:
#   jwt-secret:
#     external: true
#   stripe-api-key:
#     external: true


# ==============================================================================
# VPS SETUP CHECKLIST
# ==============================================================================
#
# 1. Initialize Docker Swarm:
#    docker swarm init
#
# 2. Create external network for Traefik:
#    docker network create --driver overlay webnet
#
# 3. Deploy Traefik stack (if using):
#    # See Traefik documentation for setup
#    docker stack deploy -c traefik-compose.yml traefik-stack
#
# 4. STUB: Create secrets (when needed):
#    printf "your-secret-key" | docker secret create jwt-secret -
#    printf "sk_live_..." | docker secret create stripe-api-key -
#
# 5. Deploy this stack:
#    # GitHub Actions will do this automatically via:
#    # cssnr/stack-deploy-action
#
# 6. Monitor deployment:
#    docker stack ls
#    docker service ls
#    docker service logs race-standings-stack_backend -f
#    docker service logs race-standings-stack_frontend -f
#
# 7. Update a service manually:
#    docker service update --image ghcr.io/user/repo-backend:sha123 race-standings-stack_backend
#
# 8. Remove stack:
#    docker stack rm race-standings-stack
#
# ==============================================================================


# ==============================================================================
# TRAEFIK SETUP (Optional - for automatic SSL)
# ==============================================================================
#
# If you ARE using Traefik:
# 1. Deploy Traefik stack first
# 2. Update "Host(`yourdomain.com`)" with your actual domain
# 3. Update network name to match your Traefik stack
# 4. Ensure DNS points to your VPS IP
#
# ==============================================================================


# ==============================================================================
# ENVIRONMENT VARIABLES (Set via GitHub Actions)
# ==============================================================================
#
# These are injected via the envfile created in deploy.yml:
#
# GIT_COMMIT_HASH     - Git commit SHA (auto-generated)
# BACKEND_IMAGE       - Full backend image URL with tag
# FRONTEND_IMAGE      - Full frontend image URL with tag
#
# ==============================================================================


# ==============================================================================
# GITHUB SECRETS REQUIRED
# ==============================================================================
#
# Set these in your GitHub repository settings:
#
# VPS_SSH_KEY        - Private SSH key for authentication
# PRODUCTION_API_URL - API URL for frontend build (e.g., https://api.yourdomain.com)
#
#
# ==============================================================================