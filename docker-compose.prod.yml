# ==============================================================================
# PRODUCTION DOCKER COMPOSE - Configuration for production deployment
# ==============================================================================
# This file defines how your app runs in production on the VPS
# It uses pre-built images from GitHub Container Registry (GHCR)
#
# Usage on VPS:
#   docker-compose -f docker-compose.prod.yml up -d
# ==============================================================================

services:
  
  # ----------------------------------------------------------------------------
  # BACKEND SERVICE - FastAPI application
  # ----------------------------------------------------------------------------
  backend:
    # Use image from GitHub Container Registry (built by CI/CD)
    # STUB: Replace ${GITHUB_REPOSITORY} with your actual repo name
    # Example: ghcr.io/username/repo-backend:main
    image: ghcr.io/${GITHUB_REPOSITORY}-backend:main
    
    container_name: race-standings-backend-prod
    restart: unless-stopped              # Auto-restart if crashes
    
    # Expose backend on port 8000
    ports:
      - "8000:8000"
    
    # Environment variables for production
    environment:
      # Basic API settings
      - PROJECT_NAME=${PROJECT_NAME:-Race Standings API}
      - VERSION=${VERSION:-1.0.0}
      - API_V1_STR=/api/v1
      
      # CORS - STUB: Add your production frontend URL
      - BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS:-["https://yourdomain.com"]}
      
      # STUB: Add database connection
      # - DATABASE_URL=${DATABASE_URL}
      
      # STUB: Add authentication secrets
      # - SECRET_KEY=${SECRET_KEY}
      # - ALGORITHM=HS256
      # - ACCESS_TOKEN_EXPIRE_MINUTES=30
      
      # STUB: Add external service keys
      # - STRIPE_API_KEY=${STRIPE_API_KEY}
      # - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      
      # STUB: Add logging/monitoring
      # - LOG_LEVEL=info
      # - SENTRY_DSN=${SENTRY_DSN}
    
    # STUB: Mount volumes for persistent data
    # volumes:
    #   - ./data:/app/data              # For file uploads
    #   - ./logs:/app/logs              # For log files
    
    networks:
      - race-standings-network
    
    # STUB: Add health check
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s


  # ----------------------------------------------------------------------------
  # FRONTEND SERVICE - React + Nginx
  # ----------------------------------------------------------------------------
  frontend:
    # Use image from GitHub Container Registry (built by CI/CD)
    # STUB: Replace ${GITHUB_REPOSITORY} with your actual repo name
    # Example: ghcr.io/username/repo-frontend:main
    image: ghcr.io/${GITHUB_REPOSITORY}-frontend:main
    
    container_name: race-standings-frontend-prod
    restart: unless-stopped              # Auto-restart if crashes
    
    # Expose frontend on port 80 (HTTP)
    # STUB: Change to 443 if using HTTPS/SSL
    ports:
      - "80:80"
      # STUB: Add HTTPS port
      # - "443:443"
    
    # STUB: Add environment variables if needed
    # environment:
    #   - VITE_API_URL=https://api.yourdomain.com
    
    # STUB: Mount SSL certificates for HTTPS
    # volumes:
    #   - /etc/letsencrypt:/etc/letsencrypt:ro   # SSL certs
    #   - ./nginx.prod.conf:/etc/nginx/conf.d/default.conf:ro
    
    depends_on:
      - backend                          # Start backend first
    
    networks:
      - race-standings-network
    
    # STUB: Add health check
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:80"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3


  # ----------------------------------------------------------------------------
  # STUB: DATABASE SERVICE (Optional)
  # ----------------------------------------------------------------------------
  # Uncomment if you want to run database in Docker
  #
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: race-standings-db-prod
  #   restart: unless-stopped
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER:-raceuser}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}      # REQUIRED in .env
  #     - POSTGRES_DB=${POSTGRES_DB:-race_standings}
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data      # Persist data
  #   ports:
  #     - "5432:5432"                                  # Expose only on localhost
  #   networks:
  #     - race-standings-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-raceuser}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5


  # ----------------------------------------------------------------------------
  # STUB: REDIS SERVICE (Optional - for caching/sessions)
  # ----------------------------------------------------------------------------
  # redis:
  #   image: redis:7-alpine
  #   container_name: race-standings-redis-prod
  #   restart: unless-stopped
  #   ports:
  #     - "127.0.0.1:6379:6379"                       # Only localhost
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - race-standings-network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5


  # ----------------------------------------------------------------------------
  # STUB: NGINX REVERSE PROXY (Optional - for SSL/multiple domains)
  # ----------------------------------------------------------------------------
  # nginx-proxy:
  #   image: nginx:alpine
  #   container_name: race-standings-nginx-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx-proxy.conf:/etc/nginx/nginx.conf:ro
  #     - /etc/letsencrypt:/etc/letsencrypt:ro
  #   depends_on:
  #     - backend
  #     - frontend
  #   networks:
  #     - race-standings-network


# ==============================================================================
# NETWORKS - Allows containers to communicate
# ==============================================================================
networks:
  race-standings-network:
    driver: bridge


# ==============================================================================
# VOLUMES - Persistent data storage
# ==============================================================================
# STUB: Uncomment if using database or persistent storage
# volumes:
#   postgres_data:      # PostgreSQL data
#   redis_data:         # Redis cache data


# ==============================================================================
# VPS ENVIRONMENT VARIABLES - Create .env file on VPS
# ==============================================================================
# Create a .env file in the same directory as this file on your VPS
#
# Required variables:
# GITHUB_REPOSITORY=username/repo-name
#
# Optional variables:
# PROJECT_NAME="Race Standings API"
# VERSION="1.0.0"
# BACKEND_CORS_ORIGINS=["https://yourdomain.com","https://www.yourdomain.com"]
#
# Database (if using):
# DATABASE_URL=postgresql://user:pass@postgres:5432/race_standings
# POSTGRES_USER=raceuser
# POSTGRES_PASSWORD=secure_password_here
# POSTGRES_DB=race_standings
#
# Authentication:
# SECRET_KEY=your-super-secret-key-change-this
#
# External services:
# STRIPE_API_KEY=sk_live_...
# SENDGRID_API_KEY=SG...
# SENTRY_DSN=https://...
#
# ==============================================================================


# ==============================================================================
# VPS DEPLOYMENT CHECKLIST
# ==============================================================================
#
# 1. Install Docker and Docker Compose on VPS:
#    curl -fsSL https://get.docker.com -o get-docker.sh
#    sudo sh get-docker.sh
#    sudo apt install docker-compose-plugin
#
# 2. Create app directory:
#    sudo mkdir -p /opt/race-standings
#    cd /opt/race-standings
#
# 3. Copy this file to VPS:
#    scp docker-compose.prod.yml user@vps:/opt/race-standings/
#
# 4. Create .env file on VPS:
#    nano .env
#    # Add GITHUB_REPOSITORY and other variables
#
# 5. Set up GitHub secrets in repository settings
#
# 6. Push code to main branch - deployment happens automatically!
#
# 7. Optional: Set up domain and SSL:
#    - Point domain to VPS IP
#    - Install certbot: sudo apt install certbot
#    - Get SSL cert: sudo certbot certonly --standalone -d yourdomain.com
#
# 8. Monitor logs:
#    docker-compose -f docker-compose.prod.yml logs -f
#
# ==============================================================================

