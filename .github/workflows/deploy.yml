# ==============================================================================
# CI/CD WORKFLOW - Automated Build and Deployment
# ==============================================================================

name: Build and Deploy to VPS

on:
  - push

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: blakexyz/race-backend
  FRONTEND_IMAGE: blakexyz/race-frontend

# ==============================================================================
# JOB 1: BUILD AND PUSH
# ==============================================================================
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------
      # STEP 1: Checkout code
      # ----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # STEP 2: Login to GHCR
      # ----------------------------------------------------------------
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------
      # STEP 3: Build and push backend
      # ----------------------------------------------------------------
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}

      # ----------------------------------------------------------------
      # STEP 4: Build and push frontend
      # ----------------------------------------------------------------
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          build-args: |
            VITE_API_URL=${{ secrets.PRODUCTION_API_URL }}

# ==============================================================================
# JOB 2: DEPLOY 
# ==============================================================================
  deploy:
    if: "contains(github.event.head_commit.message, '[deploy]')"
    runs-on: ubuntu-latest
    needs:
      - build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create env file
        run: |
          echo "GIT_COMMIT_HASH=${{ github.sha }}" >> ./envfile
          echo "BACKEND_IMAGE=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest" >> ./envfile
          echo "FRONTEND_IMAGE=${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest" >> ./envfile

      - name: Docker Stack Deploy
        uses: cssnr/stack-deploy-action@v1
        with:
          name: race-stack
          file: docker-compose.prod.yml
          host: austinrallyprojectresults.com
          user: deploy
          ssh_key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          env_file: ./envfile
          registry_auth: true
          # View stack info on VPS with:
          #   docker stack ls
          #   docker service ls
          #   docker service ps race-stack_backend --no-trunc
          #   docker service ps race-stack_frontend --no-trunc